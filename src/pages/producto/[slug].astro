---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { supabase } from '../../lib/supabase';

// 1. Obtenemos el "slug" de la URL (ej: /producto/ibuprofeno-600)
const { slug } = Astro.params;

// 2. Consultamos a Supabase
// "Traeme el producto con este slug. Y de paso, traeme sus im치genes y su categor칤a"
const { data: product, error } = await supabase
  .from('productos')
  .select(`
    *,
    categoria:categorias(nombre, slug),
    imagenes:imagenes_producto(url, texto_alt)
  `)
  .eq('slug', slug)
  .single(); // .single() es importante: devuelve un objeto, no un array de 1 elemento

// Si no existe, redirigimos al 404
if (error || !product) {
  return Astro.redirect('/404');
}

// L칩gica de Imagen Principal vs Galer칤a
// Si tiene galer칤a, usamos la primera foto. Si no, usamos el placeholder.
const mainImage = product.imagenes?.[0]?.url || 'https://placehold.co/600x400/e2e8f0/475569?text=Sin+Imagen';
---

<Layout title={`${product.nombre} - FarmaCUI`}>
  <Header />

  <main class="container mx-auto px-4 py-8">
    
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="md:flex">
        
        <div class="md:w-1/2 bg-white p-8 flex items-center justify-center">
            <img 
              src={mainImage} 
              alt={product.nombre}
              class="max-h-[400px] object-contain shadow-sm rounded-lg"
              onerror="this.src='https://placehold.co/600x400/e2e8f0/475569?text=Sin+Imagen'"
            />
        </div>

        <div class="md:w-1/2 p-8">
          
          <div class="flex justify-between items-start">
             <span class="text-sm text-farma-primary font-bold uppercase tracking-wider">
               {product.categoria?.nombre || 'General'}
             </span>
             {product.stock > 0 ? (
                <span class="bg-farma-success bg-opacity-20 text-farma-success text-xs font-bold px-2 py-1 rounded-full">
                  EN STOCK ({product.stock})
                </span>
             ) : (
                <span class="bg-farma-error bg-opacity-20 text-farma-error text-xs font-bold px-2 py-1 rounded-full">
                  SIN STOCK
                </span>
             )}
          </div>

          <h1 class="text-3xl font-bold text-farma-text mt-2 mb-4">{product.nombre}</h1>
          
          <p class="text-farma-gray text-lg mb-6 leading-relaxed">
            {product.descripcion || "Sin descripci칩n disponible para este producto."}
          </p>

          <div class="border-t border-b border-farma-muted py-6 mb-6">
             <div class="flex items-end gap-4">
                <span class="text-4xl font-bold text-farma-text">
                  $ {product.precio?.toLocaleString('es-AR')}
                </span>
                {product.costo_compra > 0 && (
                  // OJO: Esto es solo para que T칔 veas que el dato existe. 
                  // En producci칩n esto no deber칤a mostrarse al cliente.
                  <span class="text-xs text-gray-400 mb-2">
                    (Debug: Costo ${product.costo_compra})
                  </span>
                )}
             </div>
          </div>

          <div class="flex gap-4">
            <button 
              class="flex-1 bg-farma-primary hover:bg-farma-secondary text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
              onclick={`agregarAlCarrito('${product.id}', '${product.nombre}', ${product.precio})`} 
            >
              <span>游</span> Agregar al Carrito
            </button>
            
            <a 
              href="/"
              class="px-6 py-3 border border-farma-muted text-farma-text font-bold rounded-lg hover:bg-farma-accent hover:bg-opacity-10 transition-colors"
            >
              Volver
            </a>
          </div>

        </div>
      </div>
    </div>
  </main>
</Layout>

<script is:inline>
  function agregarAlCarrito(id, nombre, precio) {
    alert(`A침adido: ${nombre} ($${precio})`);
    // Aqu칤 reconectaremos tu store de NanoStores m치s adelante
  }
</script>