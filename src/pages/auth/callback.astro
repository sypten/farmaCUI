---
// src/pages/auth/callback.astro
// Esta página maneja la confirmación de email y el login automático
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmando...</title>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #9504E2 0%, #762CB6 100%);
      color: white;
    }
    .loader {
      text-align: center;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loader">
    <div class="spinner"></div>
    <p>Verificando tu cuenta...</p>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    async function handleCallback() {
      try {
        // Supabase detectará automáticamente el token en la URL
        // gracias a detectSessionInUrl: true
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error) {
          console.error('Error en callback:', error);
          window.location.href = '/login?error=verification_failed';
          return;
        }

        if (session) {
          // Sesión establecida exitosamente
          const userId = session.user.id;
          
          // 1. Verificar si existe en usuarios_sistema (staff, admin, superadmin)
          const { data: usuario } = await supabase
            .from('usuarios_sistema')
            .select('rol')
            .eq('id', userId)
            .single();

          if (usuario && ['staff', 'admin', 'superadmin'].includes(usuario.rol)) {
            // Es personal administrativo
            window.location.href = '/admin';
            return;
          }

          // 2. Si no es admin, verificar/crear en tabla clientes
          const { data: cliente } = await supabase
            .from('clientes')
            .select('id')
            .eq('id', userId)
            .single();

          if (!cliente) {
            // Crear cliente nuevo
            const { error: insertError } = await supabase
              .from('clientes')
              .insert({
                id: userId,
                nombre_completo: session.user.user_metadata.full_name || 'Usuario',
                email: session.user.email,
                telefono: null,
                direccion: null
              });

            if (insertError) {
              console.error('Error creando cliente:', insertError);
            }
          }

          // Redirigir a la home
          window.location.href = '/?verified=true';
        } else {
          // No hay sesión, redirigir al login
          window.location.href = '/login';
        }
      } catch (err) {
        console.error('Error inesperado:', err);
        window.location.href = '/login';
      }
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', handleCallback);
    } else {
      handleCallback();
    }
  </script>
</body>
</html>
