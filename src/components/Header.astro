---
import { supabase } from '../lib/supabase';
import SearchWidget from './SearchWidget.jsx';
import CategoryNav from './CategoryNav.astro'; // 1. Importamos el componente
---

<header class="bg-white shadow-sm sticky top-0 z-50">
  
  <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4">
    
    <a href="/" class="text-2xl font-black text-blue-900 flex items-center gap-2 hover:opacity-80 transition">
       FarmaCUI
    </a>

    <div class="flex-1 max-w-lg hidden md:block mx-4">
      <SearchWidget client:visible />
    </div>

    <div class="flex items-center gap-4" id="auth-section">
       
       <button id="cart-btn" class="relative p-2 text-gray-600 hover:text-blue-900 transition" title="Ver Carrito">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span id="cart-count" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center animate-bounce">0</span>
       </button>

       <div id="auth-buttons" class="flex items-center gap-2 text-sm">
         <div class="animate-pulse bg-gray-200 h-8 w-20 rounded"></div>
       </div>
    </div>

  </div>
  
  <div class="md:hidden px-4 pb-3">
    <SearchWidget client:visible />
  </div>

  <CategoryNav />

</header>

<script>
  import { supabase } from '../lib/supabase';
  import { cart } from '../store/cart';

  const authContainer = document.getElementById('auth-buttons');
  const cartBtn = document.getElementById('cart-btn');
  const cartCount = document.getElementById('cart-count');

  // 1. L贸gica del Carrito (Contador rojo)
  cart.subscribe(items => {
    const values = Object.values(items).map(item => JSON.parse(item as string));
    const totalItems = values.reduce((acc, current) => acc + current.quantity, 0);

    if (cartCount) {
      if (totalItems > 0) {
        cartCount.innerText = totalItems.toString();
        cartCount.classList.remove('hidden');
        cartCount.classList.add('flex');
      } else {
        cartCount.classList.add('hidden');
        cartCount.classList.remove('flex');
      }
    }
  });

  // Navegaci贸n al carrito
  cartBtn?.addEventListener('click', () => {
    window.location.href = '/carrito';
  });

  // 2. L贸gica de Autenticaci贸n (Usuario/Invitado)
  async function updateAuthUI() {
    if (!authContainer) return;

    const { data: { session } } = await supabase.auth.getSession();

    if (session) {
        // LOGUEADO
        const email = session.user.email || "Usuario";
        const name = session.user.user_metadata?.full_name || email.split('@')[0];
        
        // Check si es admin
        const { data: staff } = await supabase
          .from('usuarios_sistema')
          .select('rol')
          .eq('id', session.user.id)
          .single();
        
        const isAdmin = !!staff;

        authContainer.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-gray-600 font-medium hidden lg:block">Hola, ${name}</span>
                
                ${isAdmin ? `
                     <a href="/admin" class="bg-slate-800 text-white px-3 py-1.5 rounded hover:bg-slate-700 flex items-center gap-1 text-xs font-bold shadow-sm" title="Panel Admin">
                       <span>锔</span> Admin
                     </a>
                ` : ''}

                <a href="/perfil" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition text-lg" title="Mi Perfil">
                  
                </a>
                
                <button id="logout-btn" class="text-red-500 hover:text-red-700 font-semibold text-xs ml-1">
                  Salir
                </button>
            </div>
        `;

        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = '/';
        });

    } else {
        // INVITADO
        authContainer.innerHTML = `
            <a href="/login" class="font-medium text-gray-600 hover:text-blue-600 px-2">Ingresar</a>
            <a href="/registro" class="hidden sm:block bg-blue-600 text-white px-4 py-1.5 rounded-full font-bold hover:bg-blue-700 transition shadow-sm hover:shadow">
              Registrarse
            </a>
        `;
    }
  }

  updateAuthUI();
  supabase.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT' || event === 'SIGNED_IN') updateAuthUI();
  });
</script>