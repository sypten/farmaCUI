import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as i}from"./index.D55ewHcJ.js";import{d as C,a as S,b as _,r as I,c as k}from"./cart.DPhlNxo8.js";import{s as p}from"./supabase.CKd-pqSN.js";function E(t,s,o){let r=new Set(s).add(void 0);return t.listen((l,d,c)=>{r.has(c)&&o(l,d,c)})}let h=(t,s)=>o=>{t.current!==o&&(t.current=o,s())};function P(t,{keys:s,deps:o=[t,s]}={}){let r=i.useRef();r.current=t.get();let l=i.useCallback(c=>(h(r,c)(t.value),s?.length>0?E(t,s,h(r,c)):t.listen(h(r,c))),o),d=()=>r.current;return i.useSyncExternalStore(l,d,d)}async function R(t,s,o){try{const{data:r,error:l}=await p.rpc("crear_orden_compra",{p_cliente_id:s.id,p_cliente_nombre:s.name,p_total:o,p_detalles:t});if(l)throw l;if(!r.success)throw new Error(r.message);return{success:!0,orderId:r.order_id}}catch(r){return console.error("Error procesando orden:",r),{success:!1,error:r.message.replace("P0001:","").trim()}}}function L(){const t=P(k),[s,o]=i.useState([]),[r,l]=i.useState(!1),[d,c]=i.useState(!1),[m,j]=i.useState({name:"",email:""});i.useEffect(()=>{const a=Object.values(t).map(n=>JSON.parse(n));o(a)},[t]);const f=s.reduce((a,n)=>a+n.price*n.quantity,0),b=a=>{j({...m,[a.target.name]:a.target.value})},g=async a=>{a&&a.preventDefault(),l(!0);try{const{data:{user:n}}=await p.auth.getUser();let u={};if(n)u={id:n.id,name:n.user_metadata?.full_name||n.email,email:n.email};else{if(!m.name||!m.email){alert("Por favor completa tu nombre y email para el pedido."),l(!1);return}u={id:null,name:m.name,email:m.email}}const x=await R(s,u,f);x.success?(_(),alert(`¬°Gracias por tu compra, ${u.name}! üéâ
Orden #${x.orderId}
Te enviamos el detalle a ${u.email}`),window.location.href="/"):alert("Error: "+x.error)}catch(n){console.error(n),alert("Error inesperado procesando la compra.")}finally{l(!1)}},y=async()=>{const{data:{user:a}}=await p.auth.getUser();a?g():c(!0)},v=a=>S(a),w=a=>C(a),N=a=>{confirm("¬øQuitar?")&&I(a)};return s.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-farma-gray text-xl mb-4",children:"Tu carrito est√° vac√≠o üò¢"}),e.jsx("a",{href:"/",className:"bg-farma-primary text-white px-6 py-2 rounded hover:bg-farma-secondary transition",children:"Ir a comprar"})]}):e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsx("div",{className:"lg:w-2/3",children:e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:s.map(a=>e.jsxs("div",{className:"flex items-center p-4 border-b last:border-b-0 gap-4",children:[e.jsx("img",{src:a.image||"https://placehold.co/100",alt:a.name,className:"w-20 h-20 object-contain bg-white border border-farma-muted rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-farma-text",children:a.name}),e.jsxs("div",{className:"text-farma-primary font-bold mt-1",children:["$ ",a.price?.toLocaleString("es-AR")]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>w(a.id),className:"w-8 h-8 bg-gray-100 rounded-full text-blue-600 font-bold hover:bg-blue-200 flex items-center justify-center disabled:opacity-50",disabled:a.quantity<=1,children:"-"}),e.jsxs("span",{className:"font-bold text-farma-text",children:["x",a.quantity]}),e.jsx("button",{onClick:()=>v(a),className:"w-8 h-8 bg-farma-accent rounded-full text-farma-primary font-bold",children:"+"})]}),e.jsx("button",{onClick:()=>N(a.id),className:"text-farma-error hover:text-farma-error p-2",children:"üóëÔ∏è"})]},a.id))})}),e.jsx("div",{className:"lg:w-1/3",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow sticky top-24",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 border-b pb-2 text-farma-text",children:"Resumen"}),e.jsxs("div",{className:"flex justify-between mb-2 text-farma-gray",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["$ ",f.toLocaleString("es-AR")]})]}),e.jsxs("div",{className:"flex justify-between text-2xl font-bold text-farma-text mb-6",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$ ",f.toLocaleString("es-AR")]})]}),d?e.jsxs("form",{onSubmit:g,className:"animate-fade-in space-y-4 bg-white p-4 rounded border border-farma-primary",children:[e.jsx("div",{className:"text-sm text-farma-primary font-semibold mb-2",children:"Comprando como Invitado"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-farma-text mb-1",children:"Nombre Completo"}),e.jsx("input",{type:"text",name:"name",required:!0,className:"w-full border rounded p-2 focus:ring-2 focus:ring-farma-primary outline-none",placeholder:"Juan P√©rez",onChange:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-farma-text mb-1",children:"Email"}),e.jsx("input",{type:"email",name:"email",required:!0,className:"w-full border rounded p-2 focus:ring-2 focus:ring-farma-primary outline-none",placeholder:"juan@email.com",onChange:b})]}),e.jsx("button",{type:"submit",disabled:r,className:"w-full py-3 bg-farma-success hover:bg-farma-successHover text-white rounded-lg font-bold transition shadow-lg text-lg mt-2",children:r?"Procesando...":"Pagar Ahora"}),e.jsx("div",{className:"text-center mt-2",children:e.jsx("a",{href:"/login",className:"text-sm text-farma-primary hover:underline",children:"¬øYa tienes cuenta? Inicia sesi√≥n"})})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:y,disabled:r,className:"w-full py-3 bg-farma-success hover:bg-farma-successHover text-white rounded-lg font-bold transition shadow-lg text-lg",children:"Continuar Compra"}),e.jsx("p",{className:"text-center text-sm text-farma-gray",children:"Se te pedir√° iniciar sesi√≥n o continuar como invitado."})]})]})})]})}export{L as default};
